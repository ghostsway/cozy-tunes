<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="cozytunes">
<meta name="theme-color" content="#3d2b1a">
<title>cozytunes</title>

<!-- ============================================================
  SETUP INSTRUCTIONS
  1. Go to https://developer.spotify.com/dashboard
  2. Create an app (any name/description)
  3. Copy your Client ID and paste it below
  4. Under "Redirect URIs", add the URL where you host this file
     e.g. https://yourname.github.io/cozytunes/cozytunes.html
     or   http://localhost:8080 for local testing
  5. Save settings in Spotify dashboard
  6. Host this file anywhere (GitHub Pages, Netlify, etc.)
  7. Open in Safari on iPhone → Share → Add to Home Screen
============================================================ -->

<script>
  // ← PASTE YOUR CLIENT ID HERE
  const SPOTIFY_CLIENT_ID = '9f61aa90ed9e465d9bfd9f8f8b4e91e4';

  // ← This MUST match exactly what you added in Spotify dashboard
  // It should be the URL of THIS file when hosted
  const REDIRECT_URI = window.location.origin + window.location.pathname;
</script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;1,400&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --cream: #f5f0e8;
  --warm-white: #faf8f4;
  --sand: #e8dfc8;
  --toast: #c8a87a;
  --mocha: #7a5c3a;
  --espresso: #3d2b1a;
  --fog: #b8b0a4;
  --highlight: #d4a85c;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

html, body {
  height: 100%;
  width: 100%;
  overflow: hidden;
  background: var(--warm-white);
  font-family: 'Lora', Georgia, serif;
  color: var(--espresso);
  -webkit-font-smoothing: antialiased;
}

/* Grain texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 100;
}

/* ── SCREENS ───────────────────────── */
.screen {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  transition: opacity 0.5s ease, transform 0.5s ease;
}
.screen.hidden {
  opacity: 0;
  pointer-events: none;
  transform: scale(0.97);
}

/* ── LOGIN SCREEN ──────────────────── */
#loginScreen {
  align-items: center;
  justify-content: center;
  background: var(--warm-white);
  gap: 40px;
  padding: 48px 40px;
  padding-top: calc(48px + var(--safe-top));
}

.login-title {
  font-family: 'Playfair Display', serif;
  font-style: italic;
  font-size: 42px;
  color: var(--espresso);
  line-height: 1;
  text-align: center;
}

.login-sub {
  font-family: 'Lora', serif;
  font-style: italic;
  font-size: 14px;
  color: var(--fog);
  text-align: center;
  line-height: 1.7;
  max-width: 260px;
}

.login-btn {
  background: var(--espresso);
  color: var(--cream);
  border: none;
  border-radius: 40px;
  padding: 16px 48px;
  font-family: 'Lora', serif;
  font-size: 14px;
  font-style: italic;
  letter-spacing: 0.04em;
  cursor: pointer;
  box-shadow: 0 8px 32px rgba(61,43,26,0.25);
  transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
}
.login-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(61,43,26,0.3); }
.login-btn:active { transform: scale(0.97); opacity: 0.8; }

.setup-note {
  font-size: 11px;
  color: var(--fog);
  text-align: center;
  line-height: 1.8;
  max-width: 280px;
  background: var(--sand);
  padding: 16px 20px;
  border-radius: 16px;
}
.setup-note strong { color: var(--mocha); font-weight: 600; }

/* ── PLAYER SCREEN ─────────────────── */
#playerScreen {
  background: var(--warm-white);
  padding-top: var(--safe-top);
  padding-bottom: var(--safe-bottom);
}

/* Ambient bg glow from album color */
.ambient-bg {
  position: absolute;
  inset: 0;
  opacity: 0.18;
  transition: background 2s ease;
  pointer-events: none;
  z-index: 0;
}

/* Header */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 28px 0;
  position: relative;
  z-index: 1;
  flex-shrink: 0;
}

.app-name {
  font-family: 'Playfair Display', serif;
  font-style: italic;
  font-size: 13px;
  color: var(--fog);
  letter-spacing: 0.03em;
}

.now-playing-badge {
  font-family: 'Lora', serif;
  font-size: 10px;
  font-style: italic;
  color: var(--toast);
  letter-spacing: 0.06em;
  opacity: 0;
  transition: opacity 0.5s;
}
.now-playing-badge.visible { opacity: 1; }

.status-dot {
  width: 6px;
  height: 6px;
  background: var(--toast);
  border-radius: 50%;
  display: inline-block;
  margin-right: 5px;
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* Album art */
.album-wrap {
  display: flex;
  justify-content: center;
  padding: 20px 28px 0;
  flex-shrink: 0;
  position: relative;
  z-index: 1;
}

.album-art {
  width: min(200px, 48vw);
  height: min(200px, 48vw);
  border-radius: 20px;
  background: linear-gradient(145deg, #c8a87a, #4a2e18);
  position: relative;
  box-shadow: 0 16px 48px rgba(61,43,26,0.22), 0 2px 8px rgba(61,43,26,0.12);
  overflow: hidden;
  transition: transform 0.6s cubic-bezier(0.34,1.56,0.64,1);
}
.album-art.playing {
  animation: floatArt 7s ease-in-out infinite;
}
@keyframes floatArt {
  0%, 100% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-5px) scale(1.01); }
}

.album-art img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.album-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(145deg, #c8a87a 0%, #8a6040 40%, #4a2e18 100%);
}
.album-placeholder::after {
  content: '♩';
  font-family: 'Playfair Display', serif;
  font-size: 60px;
  color: rgba(255,255,255,0.22);
  font-style: italic;
}

/* Song info */
.song-info {
  padding: 16px 36px 0;
  flex-shrink: 0;
  position: relative;
  z-index: 1;
}

.song-title {
  font-family: 'Playfair Display', serif;
  font-size: clamp(18px, 5vw, 22px);
  font-weight: 500;
  color: var(--espresso);
  letter-spacing: -0.01em;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.song-artist {
  font-family: 'Lora', serif;
  font-size: 13px;
  font-style: italic;
  color: var(--toast);
  margin-top: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Progress */
.progress-wrap {
  padding: 16px 36px 0;
  flex-shrink: 0;
  position: relative;
  z-index: 1;
}

.progress-bar-bg {
  height: 3px;
  background: var(--sand);
  border-radius: 2px;
  position: relative;
  cursor: pointer;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--toast), var(--highlight));
  border-radius: 2px;
  width: 0%;
  transition: width 0.8s linear;
  position: relative;
}

.progress-bar-fill::after {
  content: '';
  position: absolute;
  right: -5px;
  top: 50%;
  transform: translateY(-50%);
  width: 10px;
  height: 10px;
  background: var(--mocha);
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(122,92,58,0.5);
}

.time-row {
  display: flex;
  justify-content: space-between;
  margin-top: 7px;
}

.time-label {
  font-size: 11px;
  color: var(--fog);
  letter-spacing: 0.03em;
  font-family: 'Lora', serif;
}

/* Controls */
.controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: clamp(24px, 8vw, 40px);
  padding: 16px 36px 0;
  flex-shrink: 0;
  position: relative;
  z-index: 1;
}

.ctrl-btn {
  border: none;
  background: none;
  cursor: pointer;
  color: var(--mocha);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s, opacity 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.ctrl-btn:active { transform: scale(0.88); opacity: 0.6; }
.ctrl-btn svg { width: 22px; height: 22px; }

.play-btn {
  width: 60px;
  height: 60px;
  background: var(--espresso);
  border-radius: 50%;
  box-shadow: 0 6px 20px rgba(61,43,26,0.28);
  transition: transform 0.15s, box-shadow 0.15s;
}
.play-btn:active { transform: scale(0.93); }
.play-btn svg { width: 22px; height: 22px; color: var(--cream); margin-left: 2px; }
.play-btn.paused svg { margin-left: 2px; }
.play-btn.playing svg { margin-left: 0; }

/* Lyrics */
.lyrics-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  padding: 16px 0 0;
  min-height: 0;
  position: relative;
  z-index: 1;
}

.lyrics-label {
  font-family: 'Lora', serif;
  font-size: 10px;
  font-style: italic;
  color: var(--fog);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 0 36px;
  margin-bottom: 10px;
  flex-shrink: 0;
}

.lyrics-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 0 36px 80px;
  mask-image: linear-gradient(transparent 0%, black 10%, black 78%, transparent 100%);
  -webkit-mask-image: linear-gradient(transparent 0%, black 10%, black 78%, transparent 100%);
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
.lyrics-scroll::-webkit-scrollbar { display: none; }

.lyric-line {
  font-family: 'Lora', serif;
  font-size: 15px;
  line-height: 1.95;
  color: var(--fog);
  transition: color 0.5s ease, transform 0.5s ease;
  transform-origin: left center;
  min-height: 1.95em;
}
.lyric-line.past { color: rgba(184, 176, 164, 0.5); }
.lyric-line.recent { color: var(--mocha); }
.lyric-line.active {
  color: var(--espresso);
  font-weight: 500;
  transform: scale(1.015);
}
.lyric-line.empty { min-height: 0.8em; }

.lyrics-empty {
  font-family: 'Lora', serif;
  font-style: italic;
  font-size: 13px;
  color: var(--fog);
  line-height: 1.8;
}

/* Error/loading states */
.status-msg {
  font-family: 'Lora', serif;
  font-style: italic;
  font-size: 13px;
  color: var(--fog);
  text-align: center;
  padding: 20px;
}

/* Bottom fade + home bar */
.home-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: calc(28px + var(--safe-bottom));
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(transparent, var(--warm-white));
  z-index: 5;
}
.home-indicator {
  width: 120px;
  height: 4px;
  background: var(--sand);
  border-radius: 2px;
  margin-bottom: calc(var(--safe-bottom) - 8px);
}

/* Disconnected state */
.disconnected-msg {
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(61,43,26,0.08);
  border-radius: 12px;
  padding: 10px 18px;
  font-family: 'Lora', serif;
  font-size: 11px;
  font-style: italic;
  color: var(--mocha);
  white-space: nowrap;
  z-index: 2;
  opacity: 0;
  transition: opacity 0.4s;
}
.disconnected-msg.visible { opacity: 1; }
</style>
</head>
<body>

<!-- ─── LOGIN SCREEN ──────────────────────────── -->
<div id="loginScreen" class="screen">
  <div class="login-title">cozytunes</div>
  <div class="login-sub">a cozy little window into what's playing</div>
  <button class="login-btn" onclick="startAuth()">connect to spotify</button>
  <div class="setup-note">
    <strong>Before connecting:</strong><br>
    Replace <code>YOUR_CLIENT_ID_HERE</code> in this file with your Spotify app's Client ID, and make sure <code>REDIRECT_URI</code> matches where you're hosting it.<br><br>
    See the comments at the top of this file for full setup instructions.
  </div>
</div>

<!-- ─── PLAYER SCREEN ─────────────────────────── -->
<div id="playerScreen" class="screen hidden">
  <div class="ambient-bg" id="ambientBg"></div>

  <div class="header">
    <span class="app-name">cozytunes</span>
    <span class="now-playing-badge" id="nowPlayingBadge">
      <span class="status-dot"></span>playing
    </span>
  </div>

  <div class="album-wrap">
    <div class="album-art" id="albumArt">
      <div class="album-placeholder" id="albumPlaceholder"></div>
      <img id="albumImg" src="" alt="" style="display:none; position:absolute; inset:0;">
    </div>
  </div>

  <div class="song-info">
    <div class="song-title" id="songTitle">—</div>
    <div class="song-artist" id="songArtist">open spotify on your device</div>
  </div>

  <div class="progress-wrap">
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>
    <div class="time-row">
      <span class="time-label" id="timeElapsed">0:00</span>
      <span class="time-label" id="timeDuration">0:00</span>
    </div>
  </div>

  <div class="controls">
    <button class="ctrl-btn" onclick="spotifySkip('previous')" title="Previous">
      <svg fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
    </button>
    <button class="ctrl-btn play-btn paused" id="playBtn" onclick="spotifyPlayPause()">
      <svg id="playIcon" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    </button>
    <button class="ctrl-btn" onclick="spotifySkip('next')" title="Next">
      <svg fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
    </button>
  </div>

  <div class="lyrics-section">
    <div class="lyrics-label">lyrics</div>
    <div class="lyrics-scroll" id="lyricsScroll">
      <div class="lyrics-empty status-msg">play something on spotify…</div>
    </div>
  </div>

  <div class="disconnected-msg" id="disconnectedMsg">spotify isn't playing anything</div>
  <div class="home-bar"><div class="home-indicator"></div></div>
</div>

<!-- ─── MAIN SCRIPT ───────────────────────────── -->
<script>
// ══════════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════════
let accessToken = null;
let refreshToken = null;
let tokenExpiry = 0;
let currentTrackId = null;
let lrcLines = []; // [{time: seconds, text: string}]
let pollInterval = null;
let progressInterval = null;
let progressMs = 0;
let durationMs = 0;
let isPlaying = false;
let lastFetchTime = Date.now();
let noTrackCount = 0;

// ══════════════════════════════════════════════
//  PKCE OAUTH
// ══════════════════════════════════════════════
function generateRandom(len) {
  const arr = new Uint8Array(len);
  crypto.getRandomValues(arr);
  return Array.from(arr, b => b.toString(16).padStart(2,'0')).join('').slice(0, len);
}

async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  return await crypto.subtle.digest('SHA-256', data);
}

function base64url(buffer) {
  return btoa(String.fromCharCode(...new Uint8Array(buffer)))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

async function startAuth() {
  if (SPOTIFY_CLIENT_ID === 'YOUR_CLIENT_ID_HERE') {
    alert('Please add your Spotify Client ID first!\n\nOpen this file in a text editor and replace YOUR_CLIENT_ID_HERE with your actual Client ID from developer.spotify.com');
    return;
  }
  const verifier = generateRandom(64);
  const challenge = base64url(await sha256(verifier));
  const state = generateRandom(16);
  sessionStorage.setItem('pkce_verifier', verifier);
  sessionStorage.setItem('pkce_state', state);

  const params = new URLSearchParams({
    client_id: SPOTIFY_CLIENT_ID,
    response_type: 'code',
    redirect_uri: REDIRECT_URI,
    scope: 'user-read-playback-state user-modify-playback-state user-read-currently-playing',
    code_challenge_method: 'S256',
    code_challenge: challenge,
    state,
  });
  window.location.href = 'https://accounts.spotify.com/authorize?' + params;
}

async function handleCallback() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  const state = params.get('state');
  const error = params.get('error');

  if (error) { showLogin(); return; }
  if (!code) return false;

  const savedState = sessionStorage.getItem('pkce_state');
  if (state !== savedState) { showLogin(); return; }

  const verifier = sessionStorage.getItem('pkce_verifier');
  const body = new URLSearchParams({
    grant_type: 'authorization_code',
    code,
    redirect_uri: REDIRECT_URI,
    client_id: SPOTIFY_CLIENT_ID,
    code_verifier: verifier,
  });

  try {
    const res = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body,
    });
    const data = await res.json();
    if (data.access_token) {
      accessToken = data.access_token;
      refreshToken = data.refresh_token;
      tokenExpiry = Date.now() + data.expires_in * 1000;
      saveTokens();
      // clean URL
      window.history.replaceState({}, '', window.location.pathname);
      showPlayer();
      return true;
    }
  } catch(e) { console.error(e); }
  showLogin();
  return false;
}

async function refreshAccessToken() {
  if (!refreshToken) { showLogin(); return false; }
  const body = new URLSearchParams({
    grant_type: 'refresh_token',
    refresh_token: refreshToken,
    client_id: SPOTIFY_CLIENT_ID,
  });
  try {
    const res = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body,
    });
    const data = await res.json();
    if (data.access_token) {
      accessToken = data.access_token;
      if (data.refresh_token) refreshToken = data.refresh_token;
      tokenExpiry = Date.now() + data.expires_in * 1000;
      saveTokens();
      return true;
    }
  } catch(e) {}
  return false;
}

async function validToken() {
  if (!accessToken) return false;
  if (Date.now() > tokenExpiry - 60000) {
    return await refreshAccessToken();
  }
  return true;
}

// ── Token persistence ──────────────────────────
function saveTokens() {
  try {
    localStorage.setItem('ct_access', accessToken);
    localStorage.setItem('ct_refresh', refreshToken);
    localStorage.setItem('ct_expiry', tokenExpiry);
  } catch(e) {}
}
function loadTokens() {
  try {
    accessToken = localStorage.getItem('ct_access');
    refreshToken = localStorage.getItem('ct_refresh');
    tokenExpiry = parseInt(localStorage.getItem('ct_expiry') || '0');
    return !!refreshToken;
  } catch(e) { return false; }
}

// ══════════════════════════════════════════════
//  SPOTIFY API
// ══════════════════════════════════════════════
async function spotifyFetch(path, method = 'GET', body = null) {
  if (!await validToken()) return null;
  const opts = {
    method,
    headers: { Authorization: 'Bearer ' + accessToken },
  };
  if (body) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(body);
  }
  try {
    const res = await fetch('https://api.spotify.com/v1' + path, opts);
    if (res.status === 401) {
      if (await refreshAccessToken()) {
        opts.headers.Authorization = 'Bearer ' + accessToken;
        return await fetch('https://api.spotify.com/v1' + path, opts);
      }
      showLogin(); return null;
    }
    if (res.status === 204 || res.status === 202 || res.status === 200) {
      if (res.status === 200) return res;
    }
    return res;
  } catch(e) { return null; }
}

async function getCurrentlyPlaying() {
  const res = await spotifyFetch('/me/player?additional_types=track');
  if (!res || res.status === 204 || res.status === 202) return null;
  try { return await res.json(); }
  catch(e) { return null; }
}

async function spotifyPlayPause() {
  if (!isPlaying) {
    await spotifyFetch('/me/player/play', 'PUT');
  } else {
    await spotifyFetch('/me/player/pause', 'PUT');
  }
  setTimeout(pollNow, 500);
}

async function spotifySkip(dir) {
  await spotifyFetch(`/me/player/${dir}`, 'POST');
  setTimeout(pollNow, 600);
}

// ══════════════════════════════════════════════
//  LRCLIB LYRICS
// ══════════════════════════════════════════════
async function fetchLyrics(track, artist, album, duration) {
  try {
    const params = new URLSearchParams({
      track_name: track,
      artist_name: artist,
      album_name: album || '',
      duration: Math.round(duration / 1000),
    });
    const res = await fetch(`https://lrclib.net/api/get?${params}`);
    if (!res.ok) return null;
    const data = await res.json();
    return data.syncedLyrics || data.plainLyrics || null;
  } catch(e) { return null; }
}

function parseLRC(lrc) {
  if (!lrc) return [];
  const lines = lrc.split('\n');
  const result = [];
  const timeRe = /^\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/;
  for (const line of lines) {
    const m = line.match(timeRe);
    if (m) {
      const secs = parseInt(m[1]) * 60 + parseInt(m[2]) + parseInt(m[3]) / (m[3].length === 3 ? 1000 : 100);
      result.push({ time: secs, text: m[4].trim() });
    }
  }
  return result.sort((a, b) => a.time - b.time);
}

function renderLyrics(lines) {
  const scroll = document.getElementById('lyricsScroll');
  if (!lines || lines.length === 0) {
    scroll.innerHTML = '<div class="lyrics-empty status-msg">no lyrics found for this track</div>';
    return;
  }
  scroll.innerHTML = lines.map((l, i) =>
    `<div class="lyric-line${l.text === '' ? ' empty' : ''}" id="ll${i}">${l.text || ''}</div>`
  ).join('');
}

function updateActiveLyric(currentSec) {
  if (!lrcLines.length) return;
  let active = 0;
  for (let i = 0; i < lrcLines.length; i++) {
    if (lrcLines[i].time <= currentSec + 0.3) active = i;
    else break;
  }
  const els = document.querySelectorAll('.lyric-line');
  els.forEach((el, i) => {
    el.classList.remove('active', 'recent', 'past');
    if (i === active) el.classList.add('active');
    else if (i === active - 1) el.classList.add('recent');
    else if (i < active - 1) el.classList.add('past');
  });
  const activeEl = document.getElementById('ll' + active);
  if (activeEl) {
    activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

// ══════════════════════════════════════════════
//  PLAYER STATE
// ══════════════════════════════════════════════
async function pollNow() {
  const data = await getCurrentlyPlaying();

  if (!data || !data.item) {
    noTrackCount++;
    if (noTrackCount > 2) {
      document.getElementById('disconnectedMsg').classList.add('visible');
      document.getElementById('nowPlayingBadge').classList.remove('visible');
      setPlayIcon(false);
    }
    return;
  }

  noTrackCount = 0;
  document.getElementById('disconnectedMsg').classList.remove('visible');

  const track = data.item;
  const playing = data.is_playing;
  progressMs = data.progress_ms || 0;
  durationMs = track.duration_ms || 0;
  isPlaying = playing;
  lastFetchTime = Date.now();

  // Update play/pause icon
  setPlayIcon(playing);
  document.getElementById('nowPlayingBadge').classList.toggle('visible', playing);
  document.getElementById('albumArt').classList.toggle('playing', playing);

  // Track changed?
  if (track.id !== currentTrackId) {
    currentTrackId = track.id;
    lrcLines = [];

    // Update UI
    document.getElementById('songTitle').textContent = track.name;
    document.getElementById('songArtist').textContent = track.artists.map(a => a.name).join(', ');
    document.getElementById('timeDuration').textContent = formatTime(durationMs);

    // Album art
    const img = track.album?.images?.[0]?.url;
    const albumImg = document.getElementById('albumImg');
    const albumPlaceholder = document.getElementById('albumPlaceholder');
    if (img) {
      albumImg.onload = () => {
        albumImg.style.display = 'block';
        albumPlaceholder.style.display = 'none';
        extractColorFromImg(albumImg);
      };
      albumImg.src = img;
    } else {
      albumImg.style.display = 'none';
      albumPlaceholder.style.display = 'flex';
    }

    // Fetch lyrics
    document.getElementById('lyricsScroll').innerHTML = '<div class="status-msg">finding lyrics…</div>';
    const rawLyrics = await fetchLyrics(
      track.name,
      track.artists[0]?.name || '',
      track.album?.name || '',
      durationMs
    );
    lrcLines = parseLRC(rawLyrics);
    renderLyrics(lrcLines);
  }

  updateProgress(progressMs, durationMs);
  updateActiveLyric(progressMs / 1000);
}

function setPlayIcon(playing) {
  isPlaying = playing;
  const btn = document.getElementById('playBtn');
  const icon = document.getElementById('playIcon');
  btn.classList.toggle('playing', playing);
  btn.classList.toggle('paused', !playing);
  icon.innerHTML = playing
    ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'
    : '<path d="M8 5v14l11-7z"/>';
}

function updateProgress(pMs, dMs) {
  const pct = dMs > 0 ? (pMs / dMs) * 100 : 0;
  document.getElementById('progressFill').style.width = Math.min(pct, 100) + '%';
  document.getElementById('timeElapsed').textContent = formatTime(pMs);
  document.getElementById('timeDuration').textContent = formatTime(dMs);
}

function formatTime(ms) {
  const s = Math.floor(ms / 1000);
  return `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;
}

// Smooth progress between polls
function startProgressTick() {
  clearInterval(progressInterval);
  progressInterval = setInterval(() => {
    if (!isPlaying) return;
    const elapsed = Date.now() - lastFetchTime;
    const estimated = progressMs + elapsed;
    if (estimated <= durationMs) {
      updateProgress(estimated, durationMs);
      updateActiveLyric(estimated / 1000);
    }
  }, 500);
}

// Ambient color extraction (rough, CSS-based)
function extractColorFromImg(img) {
  try {
    const canvas = document.createElement('canvas');
    canvas.width = canvas.height = 10;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, 10, 10);
    const d = ctx.getImageData(4, 4, 1, 1).data;
    document.getElementById('ambientBg').style.background =
      `radial-gradient(circle at 50% 30%, rgb(${d[0]},${d[1]},${d[2]}) 0%, transparent 70%)`;
  } catch(e) {}
}

// ══════════════════════════════════════════════
//  SCREEN MANAGEMENT
// ══════════════════════════════════════════════
function showLogin() {
  clearInterval(pollInterval);
  clearInterval(progressInterval);
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('playerScreen').classList.add('hidden');
}

function showPlayer() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('playerScreen').classList.remove('hidden');
  pollNow();
  pollInterval = setInterval(pollNow, 3000);
  startProgressTick();
}

// ══════════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════════
async function init() {
  // Check for OAuth callback
  if (window.location.search.includes('code=')) {
    const ok = await handleCallback();
    if (ok) return;
  }

  // Try stored tokens
  if (loadTokens() && refreshToken) {
    const ok = await refreshAccessToken();
    if (ok) { showPlayer(); return; }
  }

  showLogin();
}

init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="cozytunes">
<meta name="theme-color" content="#3d2b1a" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#1a1208" media="(prefers-color-scheme: dark)">
<title>cozytunes</title>

<!-- ============================================================
  SETUP: replace YOUR_CLIENT_ID_HERE with your Spotify Client ID
  from developer.spotify.com. REDIRECT_URI is set automatically.
============================================================ -->
<script>
  const SPOTIFY_CLIENT_ID = '9f61aa90ed9e465d9bfd9f8f8b4e91e4';
  const REDIRECT_URI = window.location.origin + window.location.pathname;
</script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;1,400&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* ── DESIGN TOKENS ─────────────────────────────────────────── */
:root {
  --bg:         #faf8f4;
  --bg2:        #f0ece3;
  --sand:       #e0d6c0;
  --fog:        #b4aba0;
  --fog2:       #8a8078;
  --text:       #3d2b1a;
  --text2:      #7a5c3a;
  --panel:      rgba(250,248,244,0.97);
  --shadow:     rgba(61,43,26,0.18);
  --safe-top:   env(safe-area-inset-top,  0px);
  --safe-bot:   env(safe-area-inset-bottom, 0px);
  --safe-left:  env(safe-area-inset-left,  0px);
  --safe-right: env(safe-area-inset-right, 0px);
  /* album-derived accent (updated by JS) */
  --alb-r: 210; --alb-g: 168; --alb-b: 92;
  --alb-r2: 160; --alb-g2: 110; --alb-b2: 60;
  --alb-r3: 80;  --alb-g3: 48;  --alb-b3: 20;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg:    #181008;
    --bg2:   #221808;
    --sand:  #2c2010;
    --fog:   #5e5650;
    --fog2:  #8a7d70;
    --text:  #f2e8d8;
    --text2: #c8a87a;
    --panel: rgba(22,14,6,0.97);
    --shadow: rgba(0,0,0,0.55);
  }
}

html, body {
  height: 100%; width: 100%;
  overflow: hidden;
  background: var(--bg);
  font-family: 'Lora', Georgia, serif;
  color: var(--text);
  -webkit-font-smoothing: antialiased;
}

/* paper grain */
body::after {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.038'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 999;
}

/* ── SCREENS ────────────────────────────────────────────────── */
.screen {
  position: fixed; inset: 0;
  display: flex; flex-direction: column;
  transition: opacity 0.45s ease, transform 0.45s ease;
  background: var(--bg);
}
.screen.hidden { opacity: 0; pointer-events: none; transform: scale(0.97); }

/* ── LOGIN ──────────────────────────────────────────────────── */
#loginScreen {
  align-items: center; justify-content: center; gap: 36px;
  padding: calc(48px + var(--safe-top)) 40px calc(48px + var(--safe-bot));
}
.login-title {
  font-family: 'Playfair Display', serif;
  font-style: italic; font-size: 44px; color: var(--text);
}
.login-sub {
  font-style: italic; font-size: 14px; color: var(--fog);
  text-align: center; line-height: 1.7; max-width: 240px;
}
.login-btn {
  background: var(--text); color: var(--bg);
  border: none; border-radius: 40px; padding: 16px 52px;
  font-family: 'Lora', serif; font-style: italic;
  font-size: 14px; letter-spacing: 0.04em; cursor: pointer;
  box-shadow: 0 8px 32px var(--shadow);
  transition: transform 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.login-btn:active { transform: scale(0.96); }
.setup-note {
  font-size: 11px; color: var(--fog); text-align: center;
  line-height: 1.8; max-width: 280px;
  background: var(--sand); padding: 16px 20px; border-radius: 16px;
}
.setup-note strong { color: var(--text2); }

/* ── PLAYER ─────────────────────────────────────────────────── */
#playerScreen { overflow: hidden; }

#ambientBg {
  position: absolute; inset: 0;
  pointer-events: none; z-index: 0;
  opacity: 0.22;
  transition: background 2.5s ease;
}
@media (prefers-color-scheme: dark) { #ambientBg { opacity: 0.38; } }

/* PORTRAIT root */
.portrait-root {
  display: flex; flex-direction: column;
  height: 100%; position: relative; z-index: 1;
  padding-top: var(--safe-top);
  padding-bottom: var(--safe-bot);
}

/* LANDSCAPE root */
.landscape-root {
  display: none;
  height: 100%; position: relative; z-index: 1;
}

@media (orientation: landscape) {
  .portrait-root { display: none; }
  .landscape-root {
    display: flex;
    padding-top: var(--safe-top);
    padding-bottom: var(--safe-bot);
    padding-left: var(--safe-left);
    padding-right: var(--safe-right);
  }

  /* left 1/3 */
  .ls-left {
    width: 34%;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 14px 18px; gap: 12px; flex-shrink: 0;
    border-right: 1px solid var(--sand);
  }

  .ls-album-art {
    width: min(150px, 26vw); height: min(150px, 26vw);
    border-radius: 16px; overflow: hidden; position: relative;
    box-shadow: 0 10px 36px var(--shadow);
    flex-shrink: 0;
  }
  .ls-album-art img { width:100%; height:100%; object-fit:cover; position:absolute; inset:0; }
  .ls-album-art .album-placeholder { width:100%; height:100%; }

  .ls-info { width: 100%; }
  .ls-title {
    font-family: 'Playfair Display', serif;
    font-size: clamp(12px,2.2vw,17px);
    font-weight: 500; color: var(--text);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    line-height: 1.2;
  }
  .ls-artist {
    font-style: italic; font-size: 11px; color: var(--text2);
    margin-top: 2px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  .ls-progress { width: 100%; }
  .ls-controls { display: flex; align-items: center; justify-content: center; gap: 14px; width: 100%; }
  .ls-controls .play-btn { width: 46px; height: 46px; }
  .ls-controls .play-btn svg { width: 18px; height: 18px; }
  .ls-controls .ctrl-btn svg { width: 17px; height: 17px; }
  .ls-volume { width: 100%; }

  /* right 2/3 */
  .ls-right {
    flex: 1; display: flex; flex-direction: column;
    overflow: hidden; padding: 16px 20px 16px 18px;
  }
  .ls-lyrics-label {
    font-size: 10px; font-style: italic; color: var(--fog);
    letter-spacing: 0.08em; text-transform: uppercase;
    margin-bottom: 8px; flex-shrink: 0;
  }
  .ls-lyrics-scroll {
    flex: 1; overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    mask-image: linear-gradient(transparent 0%, black 8%, black 84%, transparent 100%);
    -webkit-mask-image: linear-gradient(transparent 0%, black 8%, black 84%, transparent 100%);
    scroll-behavior: smooth; padding-bottom: 32px;
  }
  .ls-lyrics-scroll::-webkit-scrollbar { display: none; }
  .ls-lyrics-scroll .lyric-line { font-size: 16px; line-height: 2.05; }
}

/* ── SHARED COMPONENTS ──────────────────────────────────────── */

.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 26px 0; flex-shrink: 0;
}
.app-name {
  font-family: 'Playfair Display', serif;
  font-style: italic; font-size: 13px;
  color: var(--fog); letter-spacing: 0.03em;
}
.header-right { display: flex; align-items: center; gap: 10px; }

.now-playing-badge {
  font-size: 10px; font-style: italic;
  color: var(--text2); letter-spacing: 0.05em;
  opacity: 0; transition: opacity 0.5s;
}
.now-playing-badge.visible { opacity: 1; }
.status-dot {
  width: 6px; height: 6px;
  background: var(--text2); border-radius: 50%;
  display: inline-block; margin-right: 4px;
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.2} }

.icon-btn {
  background: none; border: none; cursor: pointer;
  color: var(--fog2); display: flex; align-items: center;
  justify-content: center; padding: 4px;
  transition: opacity 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.icon-btn:active { opacity: 0.4; }
.icon-btn svg { width: 18px; height: 18px; }

/* Album art */
.album-wrap {
  display: flex; justify-content: center;
  padding: 16px 28px 0; flex-shrink: 0;
}
.album-art {
  width: min(196px, 46vw); height: min(196px, 46vw);
  border-radius: 20px; overflow: hidden; position: relative;
  box-shadow: 0 16px 56px var(--shadow);
  transition: box-shadow 1.8s ease;
}
.album-art.playing { animation: floatArt 7s ease-in-out infinite; }
@keyframes floatArt {
  0%,100%{ transform: translateY(0) scale(1); }
  50%{ transform: translateY(-6px) scale(1.012); }
}
.album-art img {
  width:100%; height:100%; object-fit:cover;
  display:block; position:absolute; inset:0;
}
.album-placeholder {
  width:100%; height:100%;
  background: linear-gradient(145deg,
    rgb(var(--alb-r),var(--alb-g),var(--alb-b)) 0%,
    rgb(var(--alb-r2),var(--alb-g2),var(--alb-b2)) 50%,
    rgb(var(--alb-r3),var(--alb-g3),var(--alb-b3)) 100%);
  display: flex; align-items: center; justify-content: center;
  transition: background 1.5s ease;
}
.album-placeholder::after {
  content: '♩'; font-family: 'Playfair Display', serif;
  font-size: 54px; font-style: italic;
  color: rgba(255,255,255,0.2);
}

/* Song info */
.song-info { padding: 14px 34px 0; flex-shrink: 0; }
.song-title {
  font-family: 'Playfair Display', serif;
  font-size: clamp(17px, 5vw, 22px); font-weight: 500;
  color: var(--text); letter-spacing: -0.01em; line-height: 1.2;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.song-artist {
  font-size: 13px; font-style: italic; color: var(--text2);
  margin-top: 3px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* Progress */
.progress-wrap { padding: 14px 34px 0; flex-shrink: 0; }
.progress-bar-bg {
  height: 3px; background: var(--sand);
  border-radius: 2px; cursor: pointer; position: relative;
}
.progress-bar-fill {
  height: 100%; border-radius: 2px;
  background: linear-gradient(90deg,
    rgb(var(--alb-r),var(--alb-g),var(--alb-b)),
    rgb(var(--alb-r2),var(--alb-g2),var(--alb-b2)));
  width: 0%; transition: width 0.8s linear; position: relative;
}
.progress-bar-fill::after {
  content: ''; position: absolute;
  right: -5px; top: 50%; transform: translateY(-50%);
  width: 10px; height: 10px;
  background: rgb(var(--alb-r2),var(--alb-g2),var(--alb-b2));
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(var(--alb-r3),var(--alb-g3),var(--alb-b3),0.5);
}
.time-row { display: flex; justify-content: space-between; margin-top: 6px; }
.time-label { font-size: 11px; color: var(--fog); letter-spacing: 0.03em; }

/* Volume */
.volume-wrap {
  padding: 10px 34px 0;
  display: flex; align-items: center; gap: 10px; flex-shrink: 0;
}
.vol-icon { color: var(--fog); flex-shrink: 0; }
.vol-icon svg { width: 14px; height: 14px; display: block; }
input[type=range].vol-slider {
  flex: 1; -webkit-appearance: none; appearance: none;
  height: 3px; border-radius: 2px; outline: none; cursor: pointer;
  background: linear-gradient(90deg,
    rgb(var(--alb-r),var(--alb-g),var(--alb-b)) var(--vp, 60%),
    var(--sand) var(--vp, 60%));
  transition: background 0.1s;
}
input[type=range].vol-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px; height: 12px; border-radius: 50%;
  background: rgb(var(--alb-r2),var(--alb-g2),var(--alb-b2));
  box-shadow: 0 1px 6px rgba(0,0,0,0.3);
  cursor: pointer;
}

/* Controls */
.controls {
  display: flex; align-items: center; justify-content: center;
  gap: clamp(22px, 7vw, 38px);
  padding: 14px 34px 0; flex-shrink: 0;
}
.ctrl-btn {
  border: none; background: none; cursor: pointer;
  color: var(--fog2);
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.15s, opacity 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.ctrl-btn:active { transform: scale(0.86); opacity: 0.5; }
.ctrl-btn svg { width: 22px; height: 22px; }
.play-btn {
  width: 60px; height: 60px;
  background: var(--text); color: var(--bg) !important;
  border-radius: 50%;
  box-shadow: 0 6px 24px var(--shadow);
  transition: transform 0.15s, box-shadow 0.15s;
}
.play-btn svg { width: 22px; height: 22px; margin-left: 2px; }
.play-btn.playing svg { margin-left: 0; }
.play-btn:active { transform: scale(0.93); }

/* Lyrics */
.lyrics-section {
  flex: 1; display: flex; flex-direction: column;
  overflow: hidden; padding: 14px 0 0; min-height: 0;
}
.lyrics-label {
  font-size: 10px; font-style: italic; color: var(--fog);
  letter-spacing: 0.08em; text-transform: uppercase;
  padding: 0 34px; margin-bottom: 8px; flex-shrink: 0;
}
.lyrics-scroll {
  flex: 1; overflow-y: auto;
  padding: 0 34px 80px;
  mask-image: linear-gradient(transparent 0%, black 9%, black 80%, transparent 100%);
  -webkit-mask-image: linear-gradient(transparent 0%, black 9%, black 80%, transparent 100%);
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
.lyrics-scroll::-webkit-scrollbar { display: none; }
.lyric-line {
  font-family: 'Lora', serif;
  font-size: 15px; line-height: 1.95;
  color: var(--fog);
  transition: color 0.5s ease, transform 0.5s ease;
  transform-origin: left center;
  min-height: 1.95em;
}
.lyric-line.past { opacity: 0.45; }
.lyric-line.recent { color: var(--text2); }
.lyric-line.active { color: var(--text); font-weight: 500; transform: scale(1.016); }
.lyric-line.empty { min-height: 0.7em; }
.status-msg { font-style: italic; font-size: 13px; color: var(--fog); line-height: 1.8; }

/* Home bar */
.home-bar {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: calc(30px + var(--safe-bot));
  display: flex; align-items: center; justify-content: center;
  background: linear-gradient(transparent, var(--bg));
  z-index: 50; pointer-events: none;
}
.home-indicator {
  width: 120px; height: 4px;
  background: var(--sand); border-radius: 2px;
  margin-bottom: 6px;
}

/* Disconnected */
.disc-msg {
  position: absolute; bottom: 60px; left: 50%;
  transform: translateX(-50%);
  background: color-mix(in srgb, var(--text2) 12%, transparent);
  border-radius: 20px; padding: 8px 18px;
  font-size: 11px; font-style: italic; color: var(--text2);
  white-space: nowrap; z-index: 2;
  opacity: 0; transition: opacity 0.4s;
}
.disc-msg.visible { opacity: 1; }

/* ── QUEUE PANEL ────────────────────────────────────────────── */
#queuePanel {
  position: fixed; inset: 0; z-index: 200;
  pointer-events: none;
}
#queuePanel.open { pointer-events: all; }

#queueBackdrop {
  position: absolute; inset: 0;
  background: transparent;
  transition: background 0.4s ease;
  cursor: pointer;
}
#queuePanel.open #queueBackdrop { background: rgba(0,0,0,0.38); }

#queueSheet {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: var(--panel);
  border-radius: 28px 28px 0 0;
  max-height: 74vh;
  display: flex; flex-direction: column;
  transform: translateY(100%);
  transition: transform 0.44s cubic-bezier(0.32,0.72,0,1);
  box-shadow: 0 -8px 40px var(--shadow);
  padding-bottom: calc(16px + var(--safe-bot));
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
#queuePanel.open #queueSheet { transform: translateY(0); }

.queue-handle {
  width: 38px; height: 4px; background: var(--sand);
  border-radius: 2px; margin: 12px auto 0; flex-shrink: 0;
}
.queue-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 24px 8px; flex-shrink: 0;
}
.queue-title {
  font-family: 'Playfair Display', serif;
  font-style: italic; font-size: 18px; color: var(--text);
}
.queue-list {
  overflow-y: auto; flex: 1;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 8px;
}
.queue-list::-webkit-scrollbar { display: none; }
.queue-item {
  display: flex; align-items: center;
  gap: 14px; padding: 9px 24px;
  transition: background 0.15s;
  cursor: pointer;
}
.queue-item:active { background: var(--sand); }
.queue-num {
  font-size: 11px; color: var(--fog);
  width: 16px; text-align: center; flex-shrink: 0;
}
.queue-thumb {
  width: 44px; height: 44px;
  border-radius: 8px; overflow: hidden;
  flex-shrink: 0; background: var(--sand);
  position: relative;
}
.queue-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
.queue-track { flex: 1; min-width: 0; }
.queue-track-name {
  font-size: 13px; font-weight: 500; color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.queue-track-artist {
  font-size: 11px; font-style: italic; color: var(--fog2);
  margin-top: 1px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.queue-dur { font-size: 11px; color: var(--fog); flex-shrink: 0; }
.queue-empty {
  font-style: italic; font-size: 13px;
  color: var(--fog); text-align: center; padding: 40px 20px;
}
</style>
</head>
<body>

<!-- ══ LOGIN ═══════════════════════════════════════════════════ -->
<div id="loginScreen" class="screen">
  <div class="login-title">cozytunes</div>
  <div class="login-sub">a cozy little window into what you're playing</div>
  <button class="login-btn" onclick="startAuth()">connect to spotify</button>
  <div class="setup-note">
    <strong>Before connecting:</strong> replace <code>YOUR_CLIENT_ID_HERE</code> in this file with your Spotify Client ID from developer.spotify.com, and add this page's URL as a Redirect URI in your Spotify app settings.
  </div>
</div>

<!-- ══ PLAYER ══════════════════════════════════════════════════ -->
<div id="playerScreen" class="screen hidden">
  <div id="ambientBg"></div>

  <!-- ── PORTRAIT ── -->
  <div class="portrait-root">
    <div class="header">
      <span class="app-name">cozytunes</span>
      <div class="header-right">
        <span class="now-playing-badge" id="nowBadge">
          <span class="status-dot"></span>playing
        </span>
        <button class="icon-btn" onclick="openQueue()" title="Queue">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7">
            <path stroke-linecap="round" d="M3 6h18M3 11h12M3 16h8"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="album-wrap">
      <div class="album-art" id="albumArt">
        <div class="album-placeholder" id="albumPH"></div>
        <img id="albumImg" src="" alt="" crossorigin="anonymous" style="display:none">
      </div>
    </div>

    <div class="song-info">
      <div class="song-title" id="songTitle">—</div>
      <div class="song-artist" id="songArtist">open spotify on your device</div>
    </div>

    <div class="progress-wrap">
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="pFill"></div>
      </div>
      <div class="time-row">
        <span class="time-label" id="tElapsed">0:00</span>
        <span class="time-label" id="tDuration">0:00</span>
      </div>
    </div>

    <div class="volume-wrap">
      <span class="vol-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.5 12c0-1.77-1-3.29-2.5-4.03v8.05c1.5-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z"/></svg></span>
      <input type="range" class="vol-slider" id="volSlider" min="0" max="100" value="60"
        oninput="onVolInput(this.value)" onchange="commitVol(this.value)">
      <span class="vol-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></span>
    </div>

    <div class="controls">
      <button class="ctrl-btn" onclick="spSkip('previous')">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
      </button>
      <button class="ctrl-btn play-btn" id="playBtn" onclick="spToggle()">
        <svg id="playIco" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </button>
      <button class="ctrl-btn" onclick="spSkip('next')">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
      </button>
    </div>

    <div class="lyrics-section">
      <div class="lyrics-label">lyrics</div>
      <div class="lyrics-scroll" id="lyricsPT">
        <div class="status-msg">play something on spotify…</div>
      </div>
    </div>
  </div><!-- /portrait-root -->

  <!-- ── LANDSCAPE ── -->
  <div class="landscape-root">
    <!-- left column -->
    <div class="ls-left">
      <div class="ls-album-art" id="lsAlbumArt">
        <div class="album-placeholder" id="lsAlbumPH"></div>
        <img id="lsAlbumImg" src="" alt="" crossorigin="anonymous" style="display:none">
      </div>

      <div class="ls-info">
        <div class="ls-title" id="lsSongTitle">—</div>
        <div class="ls-artist" id="lsSongArtist">open spotify</div>
      </div>

      <div class="ls-progress progress-wrap" style="padding:0;">
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="lsPFill"></div>
        </div>
        <div class="time-row">
          <span class="time-label" id="lsTElapsed">0:00</span>
          <span class="time-label" id="lsTDuration">0:00</span>
        </div>
      </div>

      <div class="ls-controls controls" style="padding:0;">
        <button class="ctrl-btn" onclick="spSkip('previous')">
          <svg fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
        </button>
        <button class="ctrl-btn play-btn" id="lsPlayBtn" onclick="spToggle()">
          <svg id="lsPlayIco" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <button class="ctrl-btn" onclick="spSkip('next')">
          <svg fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
        </button>
      </div>

      <div class="ls-volume volume-wrap" style="padding:0;">
        <span class="vol-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.5 12c0-1.77-1-3.29-2.5-4.03v8.05c1.5-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z"/></svg></span>
        <input type="range" class="vol-slider" id="lsVolSlider" min="0" max="100" value="60"
          oninput="onVolInput(this.value)" onchange="commitVol(this.value)">
        <span class="vol-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></span>
      </div>

      <button class="icon-btn" onclick="openQueue()" style="gap:5px;">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7" width="17" height="17">
          <path stroke-linecap="round" d="M3 6h18M3 11h12M3 16h8"/>
        </svg>
        <span style="font-size:10px;font-style:italic;color:var(--fog);">up next</span>
      </button>
    </div>

    <!-- right column: lyrics -->
    <div class="ls-right">
      <div class="ls-lyrics-label">lyrics</div>
      <div class="ls-lyrics-scroll lyrics-scroll" id="lyricsLS">
        <div class="status-msg">play something on spotify…</div>
      </div>
    </div>
  </div><!-- /landscape-root -->

  <div class="disc-msg" id="discMsg">spotify isn't playing anything</div>
  <div class="home-bar"><div class="home-indicator"></div></div>
</div>

<!-- ══ QUEUE PANEL ═════════════════════════════════════════════ -->
<div id="queuePanel">
  <div id="queueBackdrop" onclick="closeQueue()"></div>
  <div id="queueSheet">
    <div class="queue-handle"></div>
    <div class="queue-header">
      <span class="queue-title">up next</span>
      <button class="icon-btn" onclick="closeQueue()">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
          <path stroke-linecap="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="queue-list" id="queueList">
      <div class="queue-empty">loading queue…</div>
    </div>
  </div>
</div>

<script>
// ══ STATE ════════════════════════════════════════════════════
let accessToken=null, refreshToken=null, tokenExpiry=0;
let currentTrackId=null, lrcLines=[];
let pollInt=null, progInt=null;
let progressMs=0, durationMs=0, isPlaying=false;
let lastFetch=Date.now(), noTrackN=0, volTimer=null;

// ══ PKCE AUTH ════════════════════════════════════════════════
const rnd=n=>{const a=new Uint8Array(n);crypto.getRandomValues(a);return[...a].map(x=>x.toString(16).padStart(2,'0')).join('').slice(0,n);};
const b64url=b=>btoa(String.fromCharCode(...new Uint8Array(b))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
async function sha256(s){return crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));}

async function startAuth(){
  if(SPOTIFY_CLIENT_ID==='YOUR_CLIENT_ID_HERE'){alert('Add your Spotify Client ID first!\n\nEdit this file and replace YOUR_CLIENT_ID_HERE.');return;}
  const v=rnd(64),c=b64url(await sha256(v)),st=rnd(16);
  sessionStorage.setItem('pv',v);sessionStorage.setItem('ps',st);
  location.href='https://accounts.spotify.com/authorize?'+new URLSearchParams({
    client_id:SPOTIFY_CLIENT_ID,response_type:'code',redirect_uri:REDIRECT_URI,
    scope:'user-read-playback-state user-modify-playback-state user-read-currently-playing',
    code_challenge_method:'S256',code_challenge:c,state:st
  });
}

async function handleCallback(){
  const p=new URLSearchParams(location.search);
  if(p.get('error')||!p.get('code')) return false;
  if(p.get('state')!==sessionStorage.getItem('ps')) return false;
  try{
    const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({grant_type:'authorization_code',code:p.get('code'),
        redirect_uri:REDIRECT_URI,client_id:SPOTIFY_CLIENT_ID,code_verifier:sessionStorage.getItem('pv')})});
    const d=await r.json();
    if(d.access_token){setTokens(d);history.replaceState({},'',location.pathname);return true;}
  }catch(e){}
  return false;
}

async function doRefresh(){
  if(!refreshToken) return false;
  try{
    const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({grant_type:'refresh_token',refresh_token:refreshToken,client_id:SPOTIFY_CLIENT_ID})});
    const d=await r.json();
    if(d.access_token){setTokens(d);return true;}
  }catch(e){}
  return false;
}

function setTokens(d){
  accessToken=d.access_token;
  if(d.refresh_token) refreshToken=d.refresh_token;
  tokenExpiry=Date.now()+d.expires_in*1000;
  try{localStorage.setItem('ct_a',accessToken);localStorage.setItem('ct_r',refreshToken);localStorage.setItem('ct_e',tokenExpiry);}catch(e){}
}
function loadTokens(){
  try{accessToken=localStorage.getItem('ct_a');refreshToken=localStorage.getItem('ct_r');tokenExpiry=+localStorage.getItem('ct_e')||0;return!!refreshToken;}catch(e){return false;}
}
async function validToken(){
  if(!accessToken) return false;
  if(Date.now()>tokenExpiry-60000) return doRefresh();
  return true;
}

// ══ SPOTIFY API ══════════════════════════════════════════════
async function sf(path,method='GET',body=null){
  if(!await validToken()) return null;
  const h={Authorization:'Bearer '+accessToken};
  const opts={method,headers:h};
  if(body){h['Content-Type']='application/json';opts.body=JSON.stringify(body);}
  try{
    const r=await fetch('https://api.spotify.com/v1'+path,opts);
    if(r.status===401){if(await doRefresh()){opts.headers.Authorization='Bearer '+accessToken;return fetch('https://api.spotify.com/v1'+path,opts);}showLogin();return null;}
    return r;
  }catch(e){return null;}
}

async function getNowPlaying(){
  const r=await sf('/me/player?additional_types=track');
  if(!r||r.status===204||r.status===202) return null;
  try{return r.json();}catch(e){return null;}
}
async function spToggle(){await sf('/me/player/'+(isPlaying?'pause':'play'),'PUT');setTimeout(poll,500);}
async function spSkip(dir){await sf('/me/player/'+dir,'POST');setTimeout(poll,650);}

// ══ VOLUME ═══════════════════════════════════════════════════
function onVolInput(v){
  v=parseInt(v);
  ['volSlider','lsVolSlider'].forEach(id=>{
    const el=document.getElementById(id);
    el.value=v;
    el.style.setProperty('--vp',v+'%');
  });
}
function commitVol(v){
  clearTimeout(volTimer);
  volTimer=setTimeout(()=>sf('/me/player/volume?volume_percent='+Math.round(v),'PUT'),320);
}

// ══ LYRICS ═══════════════════════════════════════════════════
async function fetchLyrics(track,artist,album,durSec){
  try{
    const r=await fetch('https://lrclib.net/api/get?'+new URLSearchParams({track_name:track,artist_name:artist,album_name:album||'',duration:Math.round(durSec)}));
    if(!r.ok) return null;
    const d=await r.json();
    return d.syncedLyrics||d.plainLyrics||null;
  }catch(e){return null;}
}
function parseLRC(lrc){
  if(!lrc) return [];
  const re=/^\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/;
  return lrc.split('\n').flatMap(l=>{
    const m=l.match(re);
    if(!m) return [];
    return [{time:+m[1]*60+ +m[2]+ +m[3]/(m[3].length===3?1000:100),text:m[4].trim()}];
  }).sort((a,b)=>a.time-b.time);
}
function renderLyrics(lines,cid){
  const el=document.getElementById(cid);
  if(!lines||!lines.length){el.innerHTML='<div class="status-msg">no lyrics found for this track</div>';return;}
  el.innerHTML=lines.map((l,i)=>`<div class="lyric-line${!l.text?' empty':''}" id="${cid}L${i}">${escHtml(l.text)||''}</div>`).join('');
}
function syncLyric(sec,cid){
  if(!lrcLines.length) return;
  let a=0;
  for(let i=0;i<lrcLines.length;i++){if(lrcLines[i].time<=sec+0.3)a=i;else break;}
  document.querySelectorAll('#'+cid+' .lyric-line').forEach((el,i)=>{
    el.classList.remove('active','recent','past');
    if(i===a)el.classList.add('active');
    else if(i===a-1)el.classList.add('recent');
    else if(i<a-1)el.classList.add('past');
  });
  const ae=document.getElementById(cid+'L'+a);
  if(ae)ae.scrollIntoView({behavior:'smooth',block:'center'});
}

// ══ COLOUR THEMING ═══════════════════════════════════════════
function extractAndApply(img){
  try{
    const c=document.createElement('canvas');
    c.width=c.height=24;
    const ctx=c.getContext('2d');
    ctx.drawImage(img,0,0,24,24);

    // collect vivid pixels
    const samples=[];
    for(let y=3;y<21;y+=3) for(let x=3;x<21;x+=3){
      const d=ctx.getImageData(x,y,1,1).data;
      const mx=Math.max(d[0],d[1],d[2]),mn=Math.min(d[0],d[1],d[2]);
      if(mx-mn>25&&mx>50&&mx<235) samples.push([d[0],d[1],d[2]]);
    }
    if(!samples.length){const d=ctx.getImageData(12,12,1,1).data;samples.push([d[0],d[1],d[2]]);}

    const avg=samples.reduce((a,c)=>[a[0]+c[0],a[1]+c[1],a[2]+c[2]],[0,0,0]).map(v=>v/samples.length);
    // boost saturation
    const grey=(avg[0]+avg[1]+avg[2])/3, sat=1.7;
    const [r,g,b]=avg.map(v=>Math.min(255,Math.max(0,grey+(v-grey)*sat)));

    const r2=r*0.62+12,g2=g*0.62+12,b2=b*0.62+12;
    const r3=r*0.28,g3=g*0.28,b3=b*0.28;

    const root=document.documentElement;
    root.style.setProperty('--alb-r',Math.round(r));
    root.style.setProperty('--alb-g',Math.round(g));
    root.style.setProperty('--alb-b',Math.round(b));
    root.style.setProperty('--alb-r2',Math.round(r2));
    root.style.setProperty('--alb-g2',Math.round(g2));
    root.style.setProperty('--alb-b2',Math.round(b2));
    root.style.setProperty('--alb-r3',Math.round(r3));
    root.style.setProperty('--alb-g3',Math.round(g3));
    root.style.setProperty('--alb-b3',Math.round(b3));

    // ambient glow — two layered ellipses
    document.getElementById('ambientBg').style.background=`
      radial-gradient(ellipse 90% 55% at 50% 0%,   rgb(${r},${g},${b}) 0%, transparent 70%),
      radial-gradient(ellipse 55% 75% at 85% 100%,  rgb(${r2},${g2},${b2}) 0%, transparent 65%)
    `;

    // album shadow matching the colour
    const sh=`rgba(${Math.round(r3)},${Math.round(g3)},${Math.round(b3)},0.4)`;
    ['albumArt','lsAlbumArt'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.style.boxShadow=`0 16px 56px ${sh}, 0 2px 8px ${sh}`;
    });

    // re-sync volume thumb colour (CSS vars handle it)
    onVolInput(document.getElementById('volSlider').value);
  }catch(e){}
}

// ══ POLL ═════════════════════════════════════════════════════
async function poll(){
  const data=await getNowPlaying();

  if(!data||!data.item){
    noTrackN++;
    if(noTrackN>2){
      document.getElementById('discMsg').classList.add('visible');
      document.getElementById('nowBadge').classList.remove('visible');
      setIcons(false);
    }
    return;
  }

  noTrackN=0;
  document.getElementById('discMsg').classList.remove('visible');

  const tr=data.item;
  isPlaying=data.is_playing;
  progressMs=data.progress_ms||0;
  durationMs=tr.duration_ms||0;
  lastFetch=Date.now();

  // volume from API
  if(data.device?.volume_percent!=null) onVolInput(data.device.volume_percent);

  setIcons(isPlaying);
  document.getElementById('nowBadge').classList.toggle('visible',isPlaying);
  document.getElementById('albumArt').classList.toggle('playing',isPlaying);

  if(tr.id!==currentTrackId){
    currentTrackId=tr.id;
    lrcLines=[];

    // text
    const title=tr.name, artist=tr.artists.map(a=>a.name).join(', ');
    document.getElementById('songTitle').textContent=title;
    document.getElementById('songArtist').textContent=artist;
    document.getElementById('lsSongTitle').textContent=title;
    document.getElementById('lsSongArtist').textContent=artist;

    // album art
    const url=tr.album?.images?.[0]?.url||'';
    loadArt(url,'albumImg','albumPH');
    loadArt(url,'lsAlbumImg','lsAlbumPH');

    // lyrics
    ['lyricsPT','lyricsLS'].forEach(id=>document.getElementById(id).innerHTML='<div class="status-msg">finding lyrics…</div>');
    const raw=await fetchLyrics(tr.name,tr.artists[0]?.name||'',tr.album?.name||'',durationMs/1000);
    lrcLines=parseLRC(raw);
    renderLyrics(lrcLines,'lyricsPT');
    renderLyrics(lrcLines,'lyricsLS');
  }

  updProgress(progressMs,durationMs);
  syncLyric(progressMs/1000,'lyricsPT');
  syncLyric(progressMs/1000,'lyricsLS');
}

function loadArt(url,imgId,phId){
  const img=document.getElementById(imgId);
  const ph=document.getElementById(phId);
  if(url){
    img.onload=()=>{img.style.display='block';ph.style.display='none';extractAndApply(img);};
    img.onerror=()=>{img.style.display='none';ph.style.display='flex';};
    img.src=url;
  }else{img.style.display='none';ph.style.display='flex';}
}

function setIcons(playing){
  isPlaying=playing;
  [['playBtn','playIco'],['lsPlayBtn','lsPlayIco']].forEach(([bId,iId])=>{
    const b=document.getElementById(bId),i=document.getElementById(iId);
    b.classList.toggle('playing',playing);
    i.innerHTML=playing?'<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>':'<path d="M8 5v14l11-7z"/>';
  });
}

function updProgress(p,d){
  const pct=d>0?(p/d)*100:0;
  document.getElementById('pFill').style.width=Math.min(pct,100)+'%';
  document.getElementById('lsPFill').style.width=Math.min(pct,100)+'%';
  const t=fmt(p),dur=fmt(d);
  document.getElementById('tElapsed').textContent=t;
  document.getElementById('lsTElapsed').textContent=t;
  document.getElementById('tDuration').textContent=dur;
  document.getElementById('lsTDuration').textContent=dur;
}
const fmt=ms=>{const s=Math.floor(ms/1000);return`${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;};

function startTick(){
  clearInterval(progInt);
  progInt=setInterval(()=>{
    if(!isPlaying) return;
    const est=progressMs+(Date.now()-lastFetch);
    if(est<=durationMs){
      updProgress(est,durationMs);
      syncLyric(est/1000,'lyricsPT');
      syncLyric(est/1000,'lyricsLS');
    }
  },500);
}

// ══ QUEUE ════════════════════════════════════════════════════
async function openQueue(){
  document.getElementById('queuePanel').classList.add('open');
  document.getElementById('queueList').innerHTML='<div class="queue-empty">loading…</div>';
  const r=await sf('/me/player/queue');
  if(!r||!r.ok){document.getElementById('queueList').innerHTML='<div class="queue-empty">couldn\'t load queue</div>';return;}
  const d=await r.json();
  const tracks=(d.queue||[]).slice(0,25);
  if(!tracks.length){document.getElementById('queueList').innerHTML='<div class="queue-empty">nothing queued up</div>';return;}
  document.getElementById('queueList').innerHTML=tracks.map((t,i)=>{
    const img=t.album?.images?.[2]?.url||t.album?.images?.[0]?.url||'';
    const artist=t.artists?.map(a=>a.name).join(', ')||'';
    return`<div class="queue-item">
      <span class="queue-num">${i+1}</span>
      <div class="queue-thumb">${img?`<img src="${escHtml(img)}" loading="lazy" alt="">`:''}</div>
      <div class="queue-track">
        <div class="queue-track-name">${escHtml(t.name)}</div>
        <div class="queue-track-artist">${escHtml(artist)}</div>
      </div>
      <span class="queue-dur">${fmt(t.duration_ms||0)}</span>
    </div>`;
  }).join('');
}
function closeQueue(){document.getElementById('queuePanel').classList.remove('open');}
const escHtml=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

// ══ NAV ══════════════════════════════════════════════════════
function showLogin(){
  clearInterval(pollInt);clearInterval(progInt);
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('playerScreen').classList.add('hidden');
}
function showPlayer(){
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('playerScreen').classList.remove('hidden');
  poll();
  pollInt=setInterval(poll,3000);
  startTick();
}

// ══ INIT ═════════════════════════════════════════════════════
async function init(){
  if(location.search.includes('code=')){if(await handleCallback()){showPlayer();return;}}
  if(loadTokens()&&refreshToken){if(await doRefresh()){showPlayer();return;}}
  showLogin();
}
init();
</script>
</body>
</html>
